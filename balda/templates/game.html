{% extends 'layout.html' %}

{% macro displayFlashes() %}
{% for category, message in get_flashed_messages(with_categories=True) %}
<div class="alert alert-{{ category }}">{{ message }}</div>
{% endfor %}
{%- endmacro %}

{% macro playerBlock(id) %}
{% set player = playerInfos[id] or None %}
  <div class="span3">
    {% if player %}
    <h2>{{ player.name }}</h2>
    <h3>{{ player.score }} points</h3>
    <h4>Words played :</h4>
    <ul>
      {% for word in player.words %}
      <li>{{ word | upper }}</li>
      {% else %}
      <li>None</li>
      {% endfor %}
    </ul>
    {% endif %}
  </div>
{% endmacro %}

{% block content %}
<div class="row">
  {{ playerBlock(0) }}
  <div id="game" class="span6">
    <h1 class="lead">{% if currentPlayer %}{{ currentPlayer.name }}'s turn{% else %}Awaiting players...{% endif %}</h1>
    <table class="table table-bordered" id="grid">
      {% for i in range(gridSize) %}
      <tr>
        {% for j in range(gridSize) %}
        <td data-x="{{i}}" data-y="{{j}}">
          {%- if gameField[i][j] -%}
          {{ gameField[i][j] | upper }}
          {%- else -%}
          <input type="text" size="1" maxlength="1" pattern="[A-Za-z]" disabled />
          {%- endif -%}
        </td>
        {% endfor %}
      </tr>
      {% endfor %}
    </table>
    {{ displayFlashes() }}
    <form action="{{ url_for('game_doMove', gameId=gameId) }}" class="form-inline" method="POST">
      Word: <strong id="word">None</strong> <button type="submit" class="btn btn-small">âž </button>
    </form>
  </div>
  {{ playerBlock(1) }}
</div>
{% endblock %}

{% block script %}
{{ super() }}
<script type="text/javascript" src="/_ah/channel/jsapi"></script>
<script>
  var newPlayerURL = {{ url_for('game_newPlayer', gameId=gameId) | tojson | safe }};

  var playerId = {{ playerId | tojson | safe }};
  var token = {{ token | tojson | safe }};

  !function ($) {
    function onOpened() {
      console.log('Channel opened');

      setTimeout(function() {
        if (playerId === null) {
          name = prompt('Enter a name', 'Alex');
          
          if (name != 'null') {
            $.post(newPlayerURL, {'name': name}, function(data) {
              console.log(data);
            });
          }
        }
      }, 10);
    }

    function onMessage(message) {
      if (message.data == 'reload') {
        document.location.reload(true);
      }
    }

    channel = new goog.appengine.Channel(token);
    socket = channel.open();
    socket.onopen = onOpened;
    socket.onmessage = onMessage;
    // socket.onerror = onError;
    // socket.onclose = onClose;
  }(window.jQuery);
</script>
{% endblock %}
